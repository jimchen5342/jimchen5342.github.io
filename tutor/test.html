<!DOCTYPE html>
<html>
<head>
  <title>未命名</title>
  <meta charset="utf-8">
  <style type="text/css">
  </style>
</head>	
<body>
</body>
<script>
	window.onload = function(){
		var pcConfig = {
			iceServers: [
        //{urls: "stun:23.21.150.121"},
        {urls: "stun:stun.l.google.com:19302", credential: "654321", username: "jimchen"},
        //{urls: "turn:numb.viagenie.ca", credential: "webrtcdemo", username: "louis%40mozilla.com"}
    	]
		}
		var pc = new RTCPeerConnection(pcConfig);

		var send = function(){
			//channel.send("Hi Peer!");
		}

		var channelOptions = {};
		let channel = pc.createDataChannel('dataChannel', channelOptions);
		channel.onmessage = function (e) {
				console.log("Got message:", e.data);
		}
		console.log(channel)

		var errorHandler = function (err) {
				console.error(err);
		};
		var options = {
				offerToReceiveAudio: true,
				offerToReceiveVideo: true
		};
		pc.createOffer().then(function(offer) {
			return pc.setLocalDescription(offer);
		})
		.then(function() {
			sendToServer({
				name: "jim",
				target: "target",
				type: "video-offer",
				sdp: pc.localDescription
			});
		})
		.catch(function(reason) {
			// An error occurred, so handle the failure to connect
		});
		/*
		pc.createOffer(function (offer) {
					pc.setLocalDescription(offer, function() {
						send("offer", JSON.stringify(pc.localDescription));
				}, errorHandler);
		}, errorHandler, options);
		*/

		// 交换 ICE 候选，通过 WebSocket 发送
		pc.onicecandidate = function (e) {
			//console.log(e)
			if (e.candidate) {
				console.log(['ICE candidate', e.candidate]);
			}
		};

		// 接收到对方添加的视频流时，显示在本地的 <video> 标签中
		pc.onaddstream = function (e) {
			console.log(e)
			remoteMediaStream = e.stream;
			remoteVideo.src = URL.createObjectURL(remoteMediaStream);
		};

		// 在这里添加上一篇文章中获取到的本地视频流
		//pc.addStream(localMediaStream);

		// 包装一个 Offer
		//pc.createOffer(gotLocalDescription, handleError);

		// 有了 Offer，通过 WebSocket 发送给对方
		function gotLocalDescription(desc) {
			pc.setLocalDescription(desc);
			socket.emit('message', roomToken, {
				'sdp': desc
			});
		}

		// 在 WebSocket 中接收到信息时
		/*
		socket.on('message', function (message, socketId) {
		if (message.sdp) {
				// 接收到 Offer 时，创建 Answer 并发送
				var desc = new RTCSessionDescription(message.sdp);
				pc.setRemoteDescription(desc, function () {
					pc.createAnswer(gotLocalDescription, handleError);
				}, handleError);
			} else {
				// 接收到 ICE 候选时，让 RTCpc 收集它，稍后它将在这些候选方式中挑选最佳者建立连接
				// 注意：RTCpc 要在 setLocalDescription 后才能开始收集 ICE 候选
				pc.addIceCandidate(new RTCIceCandidate(message.candidate));
			}
		});
		*/
	};

	//https://webrtc.github.io/samples/src/content/pc/trickle-ice/
</script>
</html>