<!DOCTYPE html>
<html>
<head>
	<title>indexedDB</title>
	<meta charset="utf-8" />
	<style type="text/css">
		h4 {
			display: inline-block;
		}
		.title {
			font-weight: 600;
			color: blue;
		}
		.gray {
			color: rgb(183, 183, 183);
		}
	</style>
	<link rel="stylesheet" href="../pattern.css">
	<script src="../../system/system.js"></script>
	<script type="text/javascript" src="../../jQuery/jquery.min.js"></script>
	<script src="../highlight.js"></script>
	<script src="system.js"></script>
</head>
<body>
		<a href='https://developer.mozilla.org/zh-TW/docs/Web/API/IndexedDB_API/Using_IndexedDB' target='_parent'>
		indexedDB 資料庫
	</a>
				
	<ol type='a'>
		<li>開啟資庫：<span class='title'>indexedDB.open</span>(name, version)
			<ol type='1'>
					<li>name：資料庫名稱</li>
					<li>version：版號(integer)</li>
					<li>返回一個 request 物件，有下列三個事件：
						<ul>
							<li>onupgradeneeded：當變更版號時，會觸發該事件；是唯一可以變更資料庫結構的地方
									<ul type='disc'>
										<li>db.createObjectStore()</li>
										<li>db.deleteObjectStore()</li>
										<li>store.createIndex()</li>
										<li>store.deleteIndex()</li>
									</ul>
							</li>
							<li>onsuccess：當資料庫開啓成功時，會觸發該事件；
								用傳入參數 event.target.result 或 request.result 來指定全域 db 物件；
								並在該事件內，指定 db 物件的 onerror 事件，用來監聽 error 事件
							</li>
							<li>onerror：</li>
						</ul>
					</li>
			</ol>
			<pre>
				<code class='javascript'>
						let db;
						let request = indexedDB.open("BiPOS", 1);
						request.onerror = function(event) {
							alert("IndexedDB open error!!");
						};
						request.onupgradeneeded = function(event) {
							let db = event.target.result;
							if(!db.objectStoreNames.contains("PRODUCT")){
								let store = db.createObjectStore("PRODUCT", {keyPath: "PLU_CODE"});
								store.createIndex("PLU_NAME", "PLU_NAME", {unique: false});
							}
						};
						request.onsuccess = function(event) {
							db = event.target.result;
							db.onerror = function(event){
							}
						};
				</code>
			</pre>			
		</li>
		<li>關閉資庫：db.<span class='title'>close</span>();</li>
		<li>建立物件庫：db.<span class='title'>createObjectStore</span>(name, options)
			<ol type='1'>
				<li>name：物件庫名稱</li>
				<li>options
					<ul>
						<li>keyPath：欄位名稱，物件庫預設索引</li>
						<li>autoIncrement：true/false，欄位值自動加一</li>
					</ul>
				</li>
				<li>返回一個 objectStore 物件，有下列事件：
					<ul>
						<li>onsuccess</li>
						<li>onerror</li>
					</ul>
				</li>
			</ol>
			註：要寫在 onupgradeneeded 事件內
		</li>
		<li>建立索引：db.<span class='title'>createIndex</span>(name, key, options)
			<ol type='1'>
				<li>name：索引名稱</li>
				<li>key：欄位名稱或欄位陣列</li>
				<li>options
					<ul>
						<li>unique：true/flase，唯一鍵值</li>
					</ul>
				</li>
			</ol>
			註：要寫在 onupgradeneeded 事件內
		</li>
		<li>開啓交易：db.<span class='title'>transaction</span>(name, mode)
			<ol type='1'>
				<li>name：物件庫名稱或陣列</li>
				<li>mode：
					<ul>
						<li>readwrite</li>
						<li>readonly(default)</li>
					</ul>
				</li>
				<li>返回一個 transaction 物件，有下列事件：
					<ul>
						<li>oncomplete</li>
						<li>onabort</li>
						<li>onerror</li>
					</ul>
				</li>
			</ol>
		</li>
		<li>開啓物件庫：transaction.<span class='title'>objectStore</span>(name)
			<ol type='1'>
				<li>name：物件庫名稱</li>
				<li>返回一個 store 物件</li>
			</ol>
		</li>
		<li>新增資料：store.<span class='title'>add</span>(value)<br/>
			返回一個 request 物件，有下列事件：
			<ul>
				<li>onsuccess</li>
				<li>onerror</li>
			</ul>
		</li>
		<li>新增或更新資料：store.<span class='title'>put</span>(value)<br/>
			返回一個 request 物件，有下列事件：
			<ul>
				<li>onsuccess</li>
				<li>onerror</li>
			</ul>
		</li>
		<li>刪除資料：store.<span class='title'>delete</span>(key)<br/>
			返回一個 request 物件，有下列事件：
			<ul>
				<li>onsuccess</li>
				<li>onerror</li>
			</ul>
		</li>
		<li>讀取資料：store.<span class='title'>get</span>(key)
			<ol type='1'>
				<li>key：物件庫的主鍵值，以 store 預設索引取得資料</li>
				<li>返回一個 request 物件，有下列事件：
					<ul>
						<li>onsuccess：當讀取完成後，觸發該事；如果找到資料，可在 request.result 取得讀取結果</li>
						<li>onerror</li>
					</ul>
				</li>
			</ol>
		</li>
		<li>cursor 存取資料：store.<span class='title'>openCursor</span>(
			<span class='gray'>[</span>IDBKeyRange, direction<span class='gray'>]</span>)
			<ol type='1'>
				<li></li>
				<li></li>
				<li>返回一個 request 物件，有下列事件：
					<ul>
						<li>onsuccess：</li>
						<li>onerror</li>
					</ul>
				</li>
			</ol>
			<!--
				openCursor 方法接收两个参数，第一个是 IDBKeyRange 对象，该对象创建方法主要有以下几种：

				// boundRange 表示主键值从1到10(包含1和10)的集合。
				// 如果第三个参数为true，则表示不包含最小键值1，如果第四参数为true，则表示不包含最大键值10，默认都为false
				var boundRange = IDBKeyRange.bound(1, 10, false, false);

				// onlyRange 表示由一个主键值的集合。only() 参数则为主键值，整数类型。
				var onlyRange = IDBKeyRange.only(1);

				// lowerRaneg 表示大于等于1的主键值的集合。
				// 第二个参数可选，为true则表示不包含最小主键1，false则包含，默认为false
				var lowerRange = IDBKeyRange.lowerBound(1, false);

				// upperRange 表示小于等于10的主键值的集合。
				// 第二个参数可选，为true则表示不包含最大主键10，false则包含，默认为false
				var upperRange = IDBKeyRange.upperBound(10, false);
				-------------------------------------------------
				openCursor 方法的第二个参数表示游标的读取方向，主要有以下几种：

				next : 游标中的数据按主键值升序排列，主键值相等的数据都被读取
				nextunique : 游标中的数据按主键值升序排列，主键值相等只读取第一条数据
				prev : 游标中的数据按主键值降序排列，主键值相等的数据都被读取
				prevunique : 游标中的数据按主键值降序排列，主键值相等只读取第一条数据

				------------------------
				request.onsuccess = function (event) {
						var cursor = event.target.result;
						if (cursor) {
								// 使用Object.assign方法是为了避免控制台打印时出错
								console.log(Object.assign(cursor.value));
								cursor.continue();
						}
				};

			-->
		</li>
		<li>使用索引：store.<span class='title'>index</span>(name)
			<ol type='1'>
				<li>name：索引名稱</li>
				<li>返回一個 index 物件，也有 get 及 openCursor 方法，可供讀取資料</li>
			</ol>
		</li>
		<li>刪除物件庫：db.<span class='title'>deleteObjectStore</span>(name)<br/>
			註：要寫在 onupgradeneeded 事件內
		</li>
		<li>刪除索引：store.<span class='title'>deleteIndex</span>(name)
		<li>刪除資料庫：indexedDB.<span class='title'>deleteDatabase</span>(name) </li>
	</ol>
	<a href='https://codepen.io/jimchen5342/pen/KbzJbK' target='_parent'>範例</a>
</body>
<script>

</script>
</html>