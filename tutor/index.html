<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>網頁教學</title>
	<link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/color.css">
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="https://www.jeasyui.com/easyui/jquery.easyui.min.js"></script>
	<style type="text/css">
		html, body{
				margin: 0;
				padding: 0;
				height:100%;
				overflow: hidden;
		}
		iframe {
			overflow: hidden;
			height: -webkit-calc(100% - (0px)); 
			width: 100%;
		}
		.myPanel {
			padding: 0px; 
			height: 100%; 
			overflow: hidden;
			height: -webkit-calc(100% - (0px));
		}
    .flexV {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
    }
		.icon-left {
			background: url(https://www.jeasyui.com/easyui/themes/default/images/layout_arrows.png) no-repeat 0 0;
		}
		.icon-right {
			background: url(https://www.jeasyui.com/easyui/themes/default/images/layout_arrows.png) no-repeat 0 -16px;
		}
		.icon-reload{
			background:url('./icons/reload.png') no-repeat center center;
		}
		#ver {
			color: blue;
			font-size: 16px;
			padding: 5px;
		}
		#divTree {
			flex: 1;
			width: 100%; 
			padding: 5px 5px;
			margin: 5px 0;
			zoom: 1.2;
			border-color: #eee;
			border-style: solid;
			border-top-width: 1px;
			border-bottom-width: 1px;
		}
	</style>
	<script src="./system/menu.js"></script>
	<script src="./system/system.js"></script>
</head>
<body class="easyui-layout" style="width: 100%; height: 100%;">
	<!--
	<div data-options="region:'north'" style="height:50px"></div>
	<div data-options="region:'south',split:true" style="height:50px;"></div>
	-->
	<div data-options="region:'west',split:true" title="課程" style="width:200px; overflow: hidden;">
		<div class="flexV" style="padding: 5px; height: 100%;">
			<select id="menu" class="easyui-combobox" style="width: 90%;" 
				data-options="valueField: 'id', textField: 'text'">
			</select>
			<div id='divTree' >
					<ul id="tree"></ul>
			</div>
			<select id="user" class="easyui-combobox" style="width: 90%;" 
				data-options="valueField: 'id', textField: 'text'">
			</select>
			<div>
				<div id='ver'>Jim Chen 2017/10/01</div>
			</div>
		</div>
	</div>
	<div data-options="region:'east',split:true" id="east" style="width:400px; overflow: hidden;">
			<div class="easyui-tabs" id="doc" style="width: 100%; height: 100%">
				<div title="講義" class='myPanel'>
						<iframe id='context' scrolling='yes' frameborder='0' seamless='seamless'
						sandbox='allow-scripts allow-top-navigation allow-same-origin allow-modals'>
					</iframe>
				</div>
				<div title="結果" class='myPanel'>
					<iframe id='result' scrolling='yes' frameborder='0' seamless='seamless'
						sandbox='allow-scripts allow-top-navigation allow-same-origin allow-modals'>
					</iframe>
				</div>
			</div>
	</div>
	<div id='center' data-options="region:'center', title:'',iconCls:'icon-ok'" style="overflow: hidden;">
			<div class="easyui-tabs" id="source" style="width: 100%; height: 100%">
				<div title="HTML" class='myPanel' src='text/html'></div>
				<div title="CSS" class='myPanel' src='css'></div>
				<div title="Javascript" class='myPanel' src='javascript'></div>
			</div>
	</div>
</body>
<script type="text/javascript">
let iframe = {}, enabled = false, result, panel = 0;
let user = [{id: 0, text: "教師版"}];

let setting = {
	HTML: "00-basic", 
	CSS: "00-basic", 
	JavaScript: "00-basic",
	current: 0
};
$( document ).ready(function(){
	let x = localStorage["setting"];
	if(typeof x == "string" && x.length > 0){
		setting = Object.assign(setting, JSON.parse(x));
	}
	adjustPanel();
	let s = "<iframe scrolling='yes' frameborder='0' seamless='seamless' " +
			"sandbox='allow-scripts allow-top-navigation allow-same-origin allow-modals'></iframe>";
	let arr = $("div[src]").get();
	for(let i = 0; i < arr.length; i++){
		let obj = $(s).appendTo(arr[i]);
		$(obj).attr("src", "codeMirror.html?mode=" + $(arr[i]).attr("src"));

		$(obj).load(function(){
			iframe[$(arr[i]).attr("src")] = $(obj).prop('contentWindow');
			iframe[$(arr[i]).attr("src")].window.changeValue = changeValue;
		});
	}

	for(let i = 0; i < menu.length; i++){
		menu[i].id = i;
	}
	$('#tree').tree({
		onClick: function(node){
			treeClick(node);  // alert node text property when clicked
		}
	});

	$('#menu').combobox({
		data: menu,
		onChange: function(newValue, oldValue){
			changeMenu(newValue);
		}
	});

	adjustUser();

	if(setting.current == 0)
		changeMenu(0);
	else 
		$('#menu').combobox('setValue', setting.current);
	result = $("#result").prop('contentWindow');
});

function adjustUser(){
	if(system.isTeacher() == false){
		user = [{id: 1, text: "自學版"}];
	}
	$('#user').combobox({
		data: user,
		onChange: function(newValue, oldValue){
			//changeMenu(newValue);
		}
	});
}
function adjustPanel(){
	let collapsed = true;
	let west = $('body').layout('panel','west').panel({
		minWidth: 160,
		//collapsed: (typeof setting["west-collapse"] == "string" && setting["west-collapse"] == "Y") ? true : false,
		onCollapse:function(){
			setting["west-collapse"] = "Y";
			localStorage["setting"] = JSON.stringify(setting);
		},
		onExpand:function(){
			setting["west-collapse"] = "N";
			localStorage["setting"] = JSON.stringify(setting);
		},
		onResize:function(w, h){
		}
	});

	if(typeof setting["west-collapse"] == "string" && setting["west-collapse"] == "Y") {
		$('body').layout('collapse', 'west');
		setTimeout(function(){
			$('body').layout('resize');
		}, 600);		
	}

	let east = $('body').layout('panel','east').panel({
		minWidth: 160,
		onCollapse:function(){
			//alert('collapse');
		},
		onExpand:function(){
			//alert('expand');
		},
		onResize:function(w, h){
			if(collapsed == false){
				setting.east = w;
				localStorage["setting"] = JSON.stringify(setting);
			}
			eastResizeIcon(w);
		}
	});
	$('#doc').tabs({ // east
			onSelect:function(title){
					//alert(title+' is selected');
			},
			tools:[{
        iconCls:'icon-left',
        handler:function(){
					collapsed = true;
					eastResize(setting.east);
					setTimeout(function(){
						collapsed = false;
					}, 500);
        }
    },{
        iconCls:'icon-right',
        handler:function(){
					collapsed = true;
					eastResize(160);
					setTimeout(function(){
						collapsed = false;
					}, 500);
        }
    }]
	});
	$('#source').tabs({ // center, 還沒寫
		onSelect:function(title){
			panel = title;
		},
		tools:[{
			iconCls:'icon-reload',
			handler:function(){
				for(let key in iframe){
					iframe[key].reset();
				}
				$("#result").attr("src", "./empty.html");
			}/*, {
			iconCls:'icon-save',
			handler:function(){
					alert('還正在思考....');
			}*/
    }]
	});

	function eastResizeIcon(w){
		if($("#doc .tabs-tool table td").size() == 0){
			setTimeout(function(){
				eastResizeIcon(w);
			}, 500);
		} else {
			let max = w > 160 ? true : false;
			$("#doc .tabs-tool table td:nth-child(1)").css("display", max == false ? "table-cell" : "none");
			$("#doc .tabs-tool table td:nth-child(2)").css("display", max == true ? "table-cell" : "none");
		}
	}
	function eastResize(w){
		var p = $('body').layout('panel','east');  
		p.panel('resize',{width: w});
		$('body').layout('resize');
		eastResizeIcon(w);
	}

	let w = typeof setting.east == "number" ? setting.east : 300;
	eastResize(w);
	setTimeout(function(){
		collapsed = false;
	}, 500);
}
function changeMenu(index){
	setting.current = index;
	let s = menu[index].text;
	$('#tree').tree({
		data: menu[index].data
	});
	findTree(setting[s]);
}

function findTree(node){
	if(menu[setting.current].data.length > 0){
		if(typeof node == "string") {
			if(node.indexOf("-") == -1){
				node = "00-basic";
			}
			node = $('#tree').tree('find', node);
		}
		if(node != null){
			$('#tree').tree('select', node.target);
			treeClick(node);
		}
	}
}
let path = "";
function treeClick(node){
	let s = menu[setting.current].text;
	setting[s] = node.id;
	localStorage["setting"] = JSON.stringify(setting);
	
	path =  menu[setting.current].text + "/";
	if(typeof node.context == "string" && node.context.length > 0){
		$("#context").attr("src", "./tutor/" + path + node["context"]);
	} else 
		$("#context").attr("src", "");
	loadPage(node);
}

function loadPage(node){
	enabled = false;
	if(typeof node.html == "string" && node.html.length > 0){
		$("#result").attr("src", "./tutor/" + path + node["html"]);
	} else 
		$("#result").attr("src", "");

	let arr = [{
		src: 'text/html', node: 'html'
	},{
			src: 'css', node: 'css'
	}, {
		src: 'javascript', node: 'js'
	}];

	function loadEditor(index){
		if(index >= arr.length){
			setTimeout(function(){
				enabled = true;
			}, 600)
		} else if (typeof iframe[arr[index].src] == "object"){
			iframe[arr[index].src].setValue(path, node[arr[index].node]);
			loadEditor(index + 1);
		} else {
			setTimeout(function(){
				loadEditor(index)
			}, 500);
		}		
	}
	loadEditor(0);
	$("#doc").tabs("select",0);
	$("#source").tabs("select",0);
}

function changeValue(e){ // 來自 iframe 修改資料
	if(enabled){
		if(e.orginal == "css"){
			changeCSS(e.data);
		} else if(e.orginal == "javascript"){
			changeJS(e.data);
		} else {
			try{
				$("#result").prop("srcdoc", e.data);
			} catch (e) {

			}
		}
	}
	//iframe["javascript"].window.changeCodeMirror("a {\n color: blue \n}");
	//$("#result").prop("srcdoc", "<span style='color: red; '>hello! world!!</span>");
}

function changeJS(js) {
	let ext = result.document.querySelector("script[src]");
	if(ext != null){
		ext.setAttribute("src", "");
		ext.parentNode.removeChild(ext);
	}

	let newJS = result.document.querySelector("#newJS");
	if(newJS != null){
		newJS.parentNode.removeChild(newJS);
	}
	newJS = result.document.createElement("script");
	newJS.id = "newJS"
	result.document.getElementsByTagName("head")[0].appendChild(newJS);
	newJS.innerHTML = js; 
}

function changeCSS(css) { // ok
	let ext = result.document.querySelector("link");
	if(ext != null){
		ext.setAttribute("href", "");
		ext.parentNode.removeChild(ext);
	}

	let newCSS = result.document.querySelector("#newCSS");
	if(newCSS != null){
		newCSS.parentNode.removeChild(newCSS);
	}
	newCSS = result.document.createElement("style");
	newCSS.id = "newCSS"
	result.document.getElementsByTagName("head")[0].appendChild(newCSS);
	newCSS.innerHTML = css; 
}
/*
cd /Users/jimc/nodeJS/ && node index
*/
</script>
</html>