<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>網頁教學</title>
	<link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/color.css">
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="https://www.jeasyui.com/easyui/jquery.easyui.min.js"></script>
	<link rel="stylesheet" type="text/css" href="./system/jquery.toast.css" />
	<script type="text/javascript" src="./system/jquery.toast.js"></script>
	<style type="text/css">
		html, body{
				margin: 0;
				padding: 0;
				height:100%;
				overflow: hidden;
		}
		iframe {
			overflow: hidden;
			height: -webkit-calc(100% - (0px)); 
			width: 100%;
		}
		.myPanel {
			padding: 0px; 
			height: 100%; 
			overflow: hidden;
			height: -webkit-calc(100% - (0px));
		}
    .flexV {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
		}
    .flexH {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
    }
		.icon-left {
			background: url(https://www.jeasyui.com/easyui/themes/default/images/layout_arrows.png) no-repeat 0 0;
		}
		.icon-right {
			background: url(https://www.jeasyui.com/easyui/themes/default/images/layout_arrows.png) no-repeat 0 -16px;
		}
		.icon-reload{
			background:url('./icons/reload.png') no-repeat center center;
		}
		#ver {
			border-top-width: 1px;
			padding: 7px 0;
			font-size: 16px;
			background-color:#eee;
			width: 100%;
			text-align: center;
		}
		#divTree {
			flex: 1;
			width: 100%; 
			padding: 5px 5px;
			margin: 5px 0 0 0;
			zoom: 1.2;
			border-color: #eee;
			border-style: solid;
			border-top-width: 1px;
			border-bottom-width: 1px;
		}

		#footer {
			height: 36px; 
			background-color: #E0ECFF;
			width: 100%; 
			padding: 5px; 
			box-sizing: border-box;
			font-size: 14px;
		}
		.switch {
			position: relative;
			display: inline-block;
			width: 52px;
			height: 26px;
		}

		.switch input {display:none;}

		.slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #ccc;
			-webkit-transition: .4s;
			transition: .4s;
		}

		.slider:before {
			position: absolute;
			content: "";
			height: 16px;
			width: 16px;
			left: 5px;
			bottom: 5px;
			background-color: white;
			-webkit-transition: .4s;
			transition: .4s;
		}

		input:checked + .slider {
			background-color: #2196F3;
		}

		input:focus + .slider {
			box-shadow: 0 0 1px #2196F3;
		}

		input:checked + .slider:before {
			-webkit-transform: translateX(26px);
			-ms-transform: translateX(26px);
			transform: translateX(26px);
		}
		.slider.round {
			border-radius: 28px;
		}

		.slider.round:before {
			border-radius: 50%;
		}
	</style>
	<script src="./system/menu.js"></script>
	<script src="./system/system.js"></script>
</head>
<body class="easyui-layout" style="width: 100%; height: 100%; visibility: hidden;">
	<!--
	<div data-options="region:'north'" style="height:50px"></div>
	<div data-options="region:'south',split:true" style="height:50px;"></div>
	-->
	<div data-options="region:'west',split:true" title="課程" style="width:200px; overflow: hidden;">
		<div class="flexV" style="padding: 0px; height: 100%; padding-top: 5px;">
			<select id="menu" class="easyui-combobox" style="width: 90%; " 
				data-options="valueField: 'id', textField: 'text'">
			</select>
			<div id='divTree' >
					<ul id="tree"></ul>
			</div>

			<div id='ver'>Jim Chen 2017/10/01</div>
		</div>
	</div>
	<div data-options="region:'east',split:true" id="east" style="width:400px; overflow: hidden;">
			<div class="easyui-tabs" id="doc" style="width: 100%; height: 100%">
				<div title="講義" class='myPanel'>
						<iframe id='context' scrolling='yes' frameborder='0' seamless='seamless'
						sandbox='allow-scripts allow-top-navigation allow-same-origin allow-modals'>
					</iframe>
				</div>
				<div title="結果" class='myPanel'>
					<iframe id='result' scrolling='yes' frameborder='0' seamless='seamless'
						sandbox='allow-scripts allow-top-navigation allow-same-origin allow-modals'>
					</iframe>
				</div>
			</div>
	</div>
	<div id='center' data-options="region:'center', title:'',iconCls:'icon-ok'" style="overflow: hidden;">
		<div style="height: 100%; " class="flexV">
			<div class="easyui-tabs" id="source" style="width: 100%; flex: 1; height: 100%;">
				<div title="HTML" class='myPanel' src='text/html'></div>
				<div title="CSS" class='myPanel' src='css'></div>
				<div title="Javascript" class='myPanel' src='javascript'></div>
			</div>
			<div id="footer" class="flexH">
				<div style="flex: 1;" id='divSubject'></div>
				<div id='divUser' >
					<select id="user" class="easyui-combobox" data-options="valueField: 'id', textField: 'text'" style='width: 120px;'></select>
				</div>
				<label class='lblSwitch'>教師版：</label>
				<label class="switch lblSwitch" id='lblSwitch'>
					<input type="checkbox" id="switch" checked>
					<span class="slider round"></span>
				</label>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript">
let iframe = {}, result, panel = 0, storage = undefined, student = "";
let subject = "", lesson = "";
let readOnly = true;
let mode = [{
		src: 'text/html', node: 'html'
	},{
			src: 'css', node: 'css'
	}, {
		src: 'javascript', node: 'js'	
}];

let setting = {
	HTML: "00-basic", 
	CSS: "00-basic", 
	JavaScript: "00-basic",
	current: 0
};
$( document ).ready(function(){
	//console.log(setting)
	result = $("#result").prop('contentWindow');
	let x = localStorage["setting"];
	if(typeof x == "string" && x.length > 0){
		setting = Object.assign(setting, JSON.parse(x));
	}
	adjustPanel();
	let s = "<iframe scrolling='yes' frameborder='0' seamless='seamless' " +
			"sandbox='allow-scripts allow-top-navigation allow-same-origin allow-modals'></iframe>";
	let arr = $("div[src]").get();
	//console.log(arr)
	for(let i = 0; i < arr.length; i++){
		let obj = $(s).appendTo(arr[i]);
		$(obj).attr("src", "codeMirror.html?mode=" + $(arr[i]).attr("src"));

		$(obj).load(function(){
			iframe[$(arr[i]).attr("src")] = $(obj).prop('contentWindow');
			iframe[$(arr[i]).attr("src")].window.changeValue = changeValue;
		});
	}

	for(let i = 0; i < menu.length; i++){
		menu[i].id = i;
	}
	$('#tree').tree({
		onClick: function(node){
			treeClick(node);  // alert node text property when clicked
		}
	});

	$('#menu').combobox({
		data: menu,
		onChange: function(newValue, oldValue){
			changeMenu(newValue);
		}
	});

	adjustUser();
	if(setting.current == 0)
		changeMenu(0);
	else 
		$('#menu').combobox('setValue', setting.current);

	$("#switch").bind("click", function(){ // 學生版, 修改否; 還沒寫.....
		readOnly = $("#switch").prop("checked");
		if(setting.information.switch < 3) {
			setting.information.switch++;
			localStorage["setting"] = JSON.stringify(setting);
			if(readOnly == false){
				setting.information.version++;
				window.showToast({
					msg: "現在, 你可以開始編輯屬於你的程式碼", 
					icon: "info",
					allowToastClose: false
				});				
			}
		}
		reload();
	});
	//console.log("teacher: " + system.isTeacher())
	if(system.isTeacher() == false){
		information();
		tooltips();
	}
	//MaskUtil.mask("test"); // ok
	//window.showToast({msg: "hi", icon: "info"}) // ok
	setTimeout(function(){
		$("body").css("visibility", "visible");
	}, 300);
});

function reload(){
	for(let i = 0; i < menu[setting.current].data.length; i++){
		let row = menu[setting.current].data[i];
		if(row.id == setting[subject]){
			loadPage(row);
			break;
		}
	}
}
function information(){
	//setting.information = undefined; // for test ...................
	setting.information = Object.assign({
		version: 0,
		signOn: 0,
		switch: 0,
	}, setting.information);

	if(setting.information.version < 3){
		setting.information.version++;
		window.showToast({
			msg: "切換下方的開關即可編輯及即時存檔", 
			icon: "info",
			allowToastClose: false
		});
	} else if(system.isSignon() == false && setting.information.signOn < 3) {
		setting.information.signOn++;
		window.showToast({
			msg: "記得要註冊哦", 
			icon: "info",
			allowToastClose: false
		});
	}
	localStorage["setting"] = JSON.stringify(setting);
}

function tooltips(){
	$('#reload').tooltip({
			position: 'bottom',
			content: '清空',
			//trackMouse:true,
			deltaX: 0,
			deltaY: 0,
			showDelay:300,
			hideDelay:500
	});
	$('#signon').tooltip({
			position: 'bottom',
			content: '註冊',
			//trackMouse:true,
			deltaX: 0,
			deltaY: 0,
			showDelay:300,
			hideDelay:500
	});

	if(setting.information.switch < 3) {
		$("#lblSwitch").tooltip({
				position: 'top',
				content: function(){
					return '關閉狀態: 即可編輯及即時存檔<br />開啟狀態: 重新載入教師版, 系統會保留你的程式碼'
				},
				//trackMouse:true,
				deltaX: 0,
				deltaY: 0,
				showDelay: 300,
				hideDelay: 500
		});
	}
}
function adjustUser(){
	if(system.isTeacher() == false){
		$('#divUser').remove();
	} else {
		let user = [{
			id: 0, text: "教師版"
		}, {
			id: "Penny", text: "Penny"
		}];
		$(".lblSwitch").remove();
		$('#user').combobox({
			data: user,
			onSelect(value){
				console.log( value)
				student = value.id == 0 ? "" : value.id;
				readOnly = value.id == 0 ? true : false; 
				loadData(function(){
					reload();
				});
			}
		});
	}
}
function adjustPanel(){
	let collapsed = true;
	let west = $('body').layout('panel','west').panel({
		minWidth: 160,
		//collapsed: (typeof setting["west-collapse"] == "string" && setting["west-collapse"] == "Y") ? true : false,
		onCollapse:function(){
			setting["west-collapse"] = "Y";
			localStorage["setting"] = JSON.stringify(setting);
		},
		onExpand:function(){
			setting["west-collapse"] = "N";
			localStorage["setting"] = JSON.stringify(setting);
		},
		onResize:function(w, h){
			//setting["west"] = w;
			//localStorage["setting"] = JSON.stringify(setting);
		}
	});

	if(typeof setting["west-collapse"] == "string" && setting["west-collapse"] == "Y") {
		$('body').layout('collapse', 'west');
		setTimeout(function(){
			$('body').layout('resize');
		}, 600);		
	}

	let east = $('body').layout('panel','east').panel({
		minWidth: 160,
		onCollapse:function(){
			//alert('collapse');
		},
		onExpand:function(){
			//alert('expand');
		},
		onResize:function(w, h){
			if(collapsed == false){
				setting.east = w;
				localStorage["setting"] = JSON.stringify(setting);
			}
			eastResizeIcon(w);
		}
	});
	$('#doc').tabs({ // east
			onSelect:function(title){
					//alert(title+' is selected');
			},
			tools:[{
        iconCls:'icon-left',
        handler:function(){
					collapsed = true;
					eastResize(setting.east);
					setTimeout(function(){
						collapsed = false;
					}, 500);
        }
    },{
        iconCls:'icon-right',
        handler:function(){
					collapsed = true;
					eastResize(160);
					setTimeout(function(){
						collapsed = false;
					}, 500);
        }
    }]
	});
	$('#source').tabs({ // center,
		onSelect:function(title){
			panel = title;
			for(let i = 0; i < mode.length; i++){
				let key = mode[i].src;
				if(key.replace("text/", "").toLowerCase() == panel.toLowerCase()){
					let x = $("div[src='" + key + "'] iframe").get();
					if(x.length == 1){
						x[0].focus();
						iframe[key].myfocus();
					}
					break;
				}
			}
		},
		tools:[{
			iconCls: 'icon-reload',
			id: 'reload',
			handler:function(){
				for(let key in iframe){
					iframe[key].reset();
				}
				$("#result").attr("src", "./empty.html");
				setTimeout(function(){
					delete storage[lesson];
					localStorage[subject] = JSON.stringify(storage);
				}, 1000)
				// firebase 要刪除，遝沒寫.....todo
			}
		}, {
			iconCls:'icon-man',
			id: "signon",
			handler:function(){
				
			}
		/*}, {
			iconCls:'icon-man',
			handler:function(){
				
			}*/
    }]
	});

	function eastResizeIcon(w){
		if($("#doc .tabs-tool table td").size() == 0){
			setTimeout(function(){
				eastResizeIcon(w);
			}, 500);
		} else {
			let max = w > 160 ? true : false;
			$("#doc .tabs-tool table td:nth-child(1)").css("display", max == false ? "table-cell" : "none");
			$("#doc .tabs-tool table td:nth-child(2)").css("display", max == true ? "table-cell" : "none");
		}
	}
	function eastResize(w){
		var p = $('body').layout('panel','east');  
		p.panel('resize',{width: w});
		$('body').layout('resize');
		eastResizeIcon(w);
	}

	let w = typeof setting.east == "number" ? setting.east : 300;
	eastResize(w);
	setTimeout(function(){
		collapsed = false;
	}, 500);
}
function centerIcon(){ // 
	//console.log("icon: " + $("#center .tabs-tool table td").size())
	if($("#center .tabs-tool table td").size() == 0){
		setTimeout(function(){
			//centerIcon();
		}, 500);
	} else {
		$("#center .tabs-tool table td:nth-child(1)").css("display", 
			readOnly ? "none" : "table-cell");
		$("#center .tabs-tool table td:nth-child(2)").css("display", 
			system.isTeacher() || system.isSignon() ? "none" : "table-cell");
		//$("#center .tabs-tool").remove();
		$('body').layout('resize');
	}
}

function changeMenu(index){
	setting.current = index;
	subject = menu[index].text;
	$('#tree').tree({
		data: menu[index].data
	});
	$("#divSubject").text(subject);
	if(system.isSignon() == true || ! system.isTeacher() || student.length > 0){ // 自 firebase 撈資料, 或 localstorage
		loadData(function(){
			findTree(setting[subject]);
		});
	} else
		findTree(setting[subject]);
}

function loadData(callback){ // firebase 還沒寫...........
	let x = localStorage[subject];
	if(typeof x == "string" && x.length > 0)
		storage = JSON.parse(x);
	else
		storage = {};
	//console.log(storage)

	if(system.isSignon() == true || student.length > 0){ // 自 firebase 撈資料
		callback();
	} else {
		callback();
	}
}

function findTree(node){
	if(menu[setting.current].data.length > 0){
		if(typeof node == "string") {
			if(node.indexOf("-") == -1){
				node = "00-basic";
			}
			node = $('#tree').tree('find', node);
		}
		if(node != null){
			$('#tree').tree('select', node.target);
			treeClick(node);
		}
	}
}

function treeClick(node){
	setting[subject] = node.id;
	localStorage["setting"] = JSON.stringify(setting);
	if(typeof node.context == "string" && node.context.length > 0){
		$("#context").attr("src", "./tutor/" + subject + "/" + node["context"]);
	} else 
		$("#context").attr("src", "");
	$("#source").tabs("select",0);
	//$("#doc").tabs("select",0);
	loadPage(node, true);
}

function loadPage(node, changed){
	lesson = node.id;
	if(typeof changed == "boolean" && changed == true){
		if((!system.isTeacher() || student.length > 0) && typeof storage == "object" && typeof storage[lesson] == "object"){
			readOnly = false;
		} else 
			readOnly = true;
		$("#switch").prop("checked", readOnly);
	}
	$("#divSubject").text(subject+ ": " + node.text);

	if(readOnly == true && typeof node.html == "string" && node.html.length > 0){
		$("#result").attr("src", "./tutor/" + subject + "/" + node["html"]);
		result.location.assign("./tutor/" + subject + "/" + node["html"]);
	} else {
		result.location.assign("./empty.html");
	}
	function loadEditor(index){
		if(index >= mode.length){
			setTimeout(function(){
				centerIcon();
			}, 600)
		} else if (typeof iframe[mode[index].src] == "object") {
			let key = mode[index].src, key2 = mode[index].node;
			if(readOnly == false && typeof storage == "object"){
				let s = typeof storage[lesson] == "object" && typeof storage[lesson][key] == "string"
					? storage[lesson][key] : "";
				if(s.length == 0 && key2 == "html"){
					iframe[key].reset();
					result.location.assign("./empty.html");
				} else {
					iframe[key].setValue(s);
					changeValue({orginal: key, data: s}, false);
				}
				//console.log(key + ": " + s)
				iframe[key].readOnly(readOnly);
				setTimeout(function(){
					loadEditor(index + 1);
				}, 600)
				
			} else {
				if(typeof node[key2] == "undefined")
					iframe[key].setValue("");
				else
					iframe[key].setValue(subject, node[key2]);
				iframe[key].readOnly(readOnly);
				$("#switch").prop("checked", readOnly);
				loadEditor(index + 1);
			}
		} else {
			setTimeout(function(){
				loadEditor(index)
			}, 500);
		}
	}
	loadEditor(0);
}

function changeValue(e, changed){ // 來自 iframe 修改資料
	if(e.orginal == "css"){
		changeCSS(e.data);
	} else if(e.orginal == "javascript"){
		changeJS(e.data);
	} else {
		try{
			if(typeof changed == "undefined" || changed == true){
				if(readOnly == false && typeof storage[lesson].css == "string" && storage[lesson].css.length > 0){
					let newCSS = '<style type="text/css" id="newCSS">' + storage[lesson].css + '</style>';
					e.data = e.data.replace("</head>", newCSS + "</head>");
				}
				if(readOnly == false && typeof storage[lesson].javascript == "string" && storage[lesson].javascript.length > 0){
					let newJS = '<script id="newJS">' + storage[lesson].javascript + '<\/script>';
					e.data = e.data.replace("</head>", newJS + "</head>");
				}
			}
			$("#result").prop("srcdoc", e.data);
		} catch (e) {

		}
	}
	if(typeof changed == "undefined" || changed == true){
		if(typeof storage[lesson] == "undefined")
				storage[lesson] = {};
			storage[lesson][e.orginal] = e.data;
			localStorage[subject] = JSON.stringify(storage);		
	}
	//iframe["javascript"].window.changeCodeMirror("a {\n color: blue \n}");
	//$("#result").prop("srcdoc", "<span style='color: red; '>hello! world!!</span>");
}

function changeJS(js) {
	let ext = result.document.querySelector("script[src]");
	if(ext != null){
		ext.setAttribute("src", "");
		ext.parentNode.removeChild(ext);
	}

	let newJS = result.document.querySelector("#newJS");
	if(newJS != null){
		newJS.parentNode.removeChild(newJS);
	}
	newJS = result.document.createElement("script");
	newJS.id = "newJS"
	result.document.getElementsByTagName("head")[0].appendChild(newJS);
	newJS.innerHTML = js;
}

function changeCSS(css) { // ok
	let ext = result.document.querySelector("link");
	if(ext != null){
		ext.setAttribute("href", "");
		ext.parentNode.removeChild(ext);
	}

	let newCSS = result.document.querySelector("#newCSS");
	if(newCSS != null){
		newCSS.parentNode.removeChild(newCSS);
	}
	newCSS = result.document.createElement("style");
	newCSS.id = "newCSS"
	result.document.getElementsByTagName("head")[0].appendChild(newCSS);
	newCSS.innerHTML = css;
}
/*
cd /Users/jimc/nodeJS/ && node index
*/
</script>
</html>