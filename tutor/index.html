<!DOCTYPE html>
<html>
<head>
	<title>即時互動-網頁教學</title>
	<meta charset="UTF-8" />
	<meta http-equiv="cache-control" content="no-cache" />
	<meta http-equiv="expires" content="0" />
	<meta name="description" content="教學內容互動" />
	<meta name="keywords" content="網頁教學" />
	<meta name="author" content="陳進明" />
	<link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/color.css">
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="https://www.jeasyui.com/easyui/jquery.easyui.min.js"></script>
	<link rel="stylesheet" type="text/css" href="./system/jquery.toast.css" />
	<script type="text/javascript" src="./system/jquery.toast.js"></script>
	<style type="text/css">
		html, body{
				margin: 0;
				padding: 0;
				height:100%;
				overflow: hidden;
		}
		iframe {
			overflow: hidden;
			height: -webkit-calc(100% - (0px)); 
			width: 100%;
		}
		.myPanel {
			padding: 0px; 
			height: 100%; 
			overflow: hidden;
			height: -webkit-calc(100% - (0px));
		}
    .flexV {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
		}
    .flexH {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
    }
		.icon-left {
			background: url(https://www.jeasyui.com/easyui/themes/default/images/layout_arrows.png) no-repeat 0 0;
		}
		.icon-right {
			background: url(https://www.jeasyui.com/easyui/themes/default/images/layout_arrows.png) no-repeat 0 -16px;
		}
		.icon-reload{
			background:url('./icons/reload.png') no-repeat center center;
		}
		.icon-speech{
			background:url('./icons/speech.png') no-repeat center center;
			background-size: 16px 16px;
		}
		#ver {
			border-top-width: 1px;
			padding: 7px 0;
			font-size: 16px;
			background-color:#eee;
			width: 100%;
			text-align: center;
		}
		#divTree {
			flex: 1;
			width: 100%; 
			padding: 5px 5px;
			margin: 5px 0 0 0;
			zoom: 1.2;
			border-color: #eee;
			border-style: solid;
			border-top-width: 1px;
			border-bottom-width: 1px;
		}

		#footer {
			height: 36px; 
			background-color: #E0ECFF;
			width: 100%; 
			padding: 5px; 
			box-sizing: border-box;
			font-size: 14px;
		}
		#divSubject {
			overflow : hidden;
			text-overflow : ellipsis;
			white-space : nowrap;
		}
		.switch {
			position: relative;
			display: inline-block;
			width: 52px;
			height: 26px;
		}

		.switch input {display:none;}

		.slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #ccc;
			-webkit-transition: .4s;
			transition: .4s;
		}

		.slider:before {
			position: absolute;
			content: "";
			height: 16px;
			width: 16px;
			left: 5px;
			bottom: 5px;
			background-color: white;
			-webkit-transition: .4s;
			transition: .4s;
		}

		input:checked + .slider {
			background-color: #2196F3;
		}

		input:focus + .slider {
			box-shadow: 0 0 1px #2196F3;
		}

		input:checked + .slider:before {
			-webkit-transform: translateX(26px);
			-ms-transform: translateX(26px);
			transform: translateX(26px);
		}
		.slider.round {
			border-radius: 28px;
		}

		.slider.round:before {
			border-radius: 50%;
		}

		#winEdit .footer {
			padding: 5px; 
			width: 100%;  
			flex-direction: row;
			display: flex;
			align-items: flex-end;
			justify-content: flex-end;
			/*padding: 10px 0 10px 10px;*/
		} 
		#winEdit {
			padding: 5px;
			box-sizing: border-box;
			overflow: hidden;
			background-color: white;
			font-size: 1.0em;
		}
		#winEdit label {
			color: blue;
			font-size: 1.0em;
		} 
		#winEdit input {
			font-size: 1.0em;
			width: 100%;
			height: 26px;
		}
		#winEdit button {
			width: 100px;
			font-size: 1.0em;
			margin-left: 5px;
			padding: 5px 5px;
		}
	</style>
	<script src="./system/storage.js"></script>
	<script src="./system/menu.js"></script>
	<script src="./system/system.js"></script>
	<script src="./system/firebase.js"></script>
	<script src="./system/AES.js"></script>
	<script src="./system/crypt.js"></script>
	<script src="./extend/String.js"></script>

	<link rel="stylesheet" type="text/css" href="./components/speech.css" />
	<script src="./components/speech.js"></script>
</head>
<body class="easyui-layout" style="width: 100%; height: 100%; visibility: hidden;">
	<!--
	<div data-options="region:'north'" style="height:50px"></div>
	<div data-options="region:'south',split:true" style="height:50px;"></div>
	-->
	<div data-options="region:'west',split:true" title="課程" style="width:200px; overflow: hidden;">
		<div class="flexV" style="padding: 0px; height: 100%; padding-top: 5px;">
			<select id="menu" class="easyui-combobox" style="width: 90%; " 
				data-options="valueField: 'id', textField: 'text'">
			</select>
			<div id='divTree' >
					<ul id="tree"></ul>
			</div>

			<div id='ver'></div>
		</div>
	</div>
	<div data-options="region:'east',split:true" id="east" style="width:400px; overflow: hidden;">
			<div class="easyui-tabs" id="doc" style="width: 100%; height: 100%">
				<div title="講義" class='myPanel'>
						<iframe id='context' scrolling='yes' frameborder='0' seamless='seamless'
						sandbox='allow-scripts allow-top-navigation allow-same-origin allow-modals' />
					<!--</iframe>-->
				</div>
				<div title="執行結果" class='myPanel'>
					<iframe id='result' scrolling='yes' frameborder='0' seamless='seamless'
						sandbox='allow-scripts allow-top-navigation allow-same-origin allow-modals'>
					</iframe>
				</div>
			</div>
	</div>
	<div id='center' data-options="region:'center', title:'',iconCls:'icon-ok'" style="overflow: hidden;">
		<div style="height: 100%; " class="flexV">
			<div class="easyui-tabs" id="source" style="width: 100%; flex: 1; height: 100%;">
				<div title="HTML" class='myPanel' src='html'></div>
				<div title="CSS" class='myPanel' src='css'></div>
				<div title="Javascript" class='myPanel' src='javascript'></div>
			</div>
			<div id="footer" class="flexH">
				<div style="flex: 1;" id='divSubject'></div>
				<div id='divUser' >
					<select id="user" class="easyui-combobox" data-options="valueField: 'id', textField: 'text'" style='width: 120px;'></select>
				</div>
				<label class='lblSwitch'>教師版：</label>
				<label class="switch lblSwitch" id='lblSwitch'>
					<input type="checkbox" id="switch" checked>
					<span class="slider round"></span>
				</label>
			</div>
		</div>
	</div>
	<div id="winSpeech" class="easyui-window" title="訊息" style="width:300px;height:450px"
		data-options="iconCls:'icon-save',modal:false,closed:true,resizable:false,minimizable:false">
		<div class="easyui-layout" data-options="fit:true" id='layoutSpeech'>
			<div data-options="region:'north',split:true" style="height:300px">
				<div id='divSpeech'></div>
			</div>
			<div data-options="region:'south'" style="overflow: hidden;">
				<div class='flexH' style="padding: 5px;">
					<input type='radio' id='rdAll' name='rdSpeech' />
					<label for='rdAll' style="margin-right: 10px;font-size: 16px;">全部</label>
					<input type='radio' id='rdstudent' name='rdSpeech' checked/>
					<label for='rdstudent' id='lblStudent' style='font-size: 16px;'>學生</label>
				</div>
			</div>
			<div data-options="region:'center'" style="overflow: hidden;">
				<textarea id='taSpeech'></textarea>
			</div>
		</div>
		</div>
	</div>
</body>
<script type="text/javascript">
let iframe = {}, result, panel = 0, userData = undefined, student = "";
let subject = "", lesson = "";
let readOnly = true;
let mode = [{
		src: 'html', node: 'html'
	},{
			src: 'css', node: 'css'
	}, {
		src: 'javascript', node: 'js'	
}];

let setting = storage.Setting();
$( document ).ready(function(){
	$("#ver").text("Jim Chen 2017/10/08");
	//console.log(setting)
	result = $("#result").prop('contentWindow');
	adjustPanel();
	let s = "<iframe scrolling='yes' frameborder='0' seamless='seamless' " +
			"sandbox='allow-scripts allow-top-navigation allow-same-origin allow-modals'></iframe>";
	let arr = $("div[src]").get();
	//console.log(arr)
	for(let i = 0; i < arr.length; i++){
		let obj = $(s).appendTo(arr[i]);
		$(obj).attr("src", "codeMirror.html?mode=" + $(arr[i]).attr("src"));

		$(obj).load(function(){
			iframe[$(arr[i]).attr("src")] = $(obj).prop('contentWindow');
			iframe[$(arr[i]).attr("src")].window.changeValue = changeValue;
		});
	}

	for(let i = 0; i < menu.length; i++){
		menu[i].id = i;
	}
	$('#tree').tree({
		onClick: function(node){
			treeClick(node);  // alert node text property when clicked
		}
	});

	$('#menu').combobox({
		data: menu,
		onChange: function(newValue, oldValue){
			console.log(newValue)
			changeMenu(newValue);
		}
	});

	adjustUser();
	if(setting.current == 0){
		changeMenu(0);
	} else 
		$('#menu').combobox('setValue', setting.current);

	$("#switch").bind("click", function(){ // 學生版, 修改否
		readOnly = $("#switch").prop("checked");
		if(system.isSignon() == false && setting.information.switch < 3) {
			setting.information.switch++;
			storage.Setting(setting);
			if(readOnly == false){
				setting.information.version++;
				window.showToast({
					msg: "現在, 你可以開始編輯屬於你的程式碼", 
					icon: "info",
					allowToastClose: false
				});				
			}
		}
		if(typeof userData == "undefined")
			userData = {};
		reload();
	});
	//console.log("teacher: " + system.isTeacher())
	if(system.isTeacher() == false){
		information();
	}
	tooltips();
	//MaskUtil.mask("test"); // ok
	//window.showToast({msg: "hi", icon: "info"}) // ok
	setTimeout(function(){
		$("body").css("visibility", "visible");
	}, 300);
	if(system.isSignon())
		speech.adjust();
});

function reload(){
	for(let i = 0; i < menu[setting.current].data.length; i++){
		let row = menu[setting.current].data[i];
		if(row.id == setting[subject]){
			loadPage(row);
			break;
		}
	}
}
function information(){
	if(system.isSignon() == true) return;
	//setting.information = undefined; // for test ...................
	setting.information = Object.assign({
		version: 0,
		signOn: 0,
		switch: 0,
	}, setting.information);

	if(setting.information.version < 3){
		setting.information.version++;
		window.showToast({
			msg: "切換下方的開關即可編輯及即時存檔", 
			icon: "info",
			allowToastClose: false
		});
	} else if(system.isSignon() == false && setting.information.signOn < 3) {
		setting.information.signOn++;
		window.showToast({
			msg: "記得要註冊哦", 
			icon: "info",
			allowToastClose: false
		});
	}
	storage.Setting(setting);
}

function tooltips(){
	$('#speech').tooltip({
			position: 'bottom',
			content: '訊息',
			//trackMouse:true,
			deltaX: 0,
			deltaY: 0,
			showDelay:300,
			hideDelay:500
	});
	//if(system.isSignon() == true) return;
	$('#reload').tooltip({
			position: 'bottom',
			content: system.isTeacher() ? 'reload' : '清空',
			//trackMouse:true,
			deltaX: 0,
			deltaY: 0,
			showDelay:300,
			hideDelay:500
	});
	$('#signon').tooltip({
			position: 'bottom',
			content: system.isSignon() ? '登出：<br />' + storage.System().user : '註冊',
			//trackMouse:true,
			deltaX: 0,
			deltaY: 0,
			showDelay:300,
			hideDelay:500
	});

	$('#student').tooltip({
			position: 'bottom',
			content: '學生管理',
			//trackMouse:true,
			deltaX: 0,
			deltaY: 0,
			showDelay:300,
			hideDelay:500
	});

	if(setting.information.switch < 3) {
		$("#lblSwitch").tooltip({
				position: 'top',
				content: function(){
					return '關閉狀態: 即可編輯及即時存檔<br />開啟狀態: 重新載入教師版, 系統會保留你的程式碼'
				},
				//trackMouse:true,
				deltaX: 0,
				deltaY: 0,
				showDelay: 300,
				hideDelay: 500
		});
	}
}
function studentAdd(){
	if(speechOpened) $('#winSpeech').window('close');
	//console.log(storage.System());
	if($("#winEdit").get().length > 0) {
			$("#winEdit").remove();
	}

	let div = $("<div id='winEdit' class='flexV' style='overflow: hidden; padding: 3px;' />").appendTo("body");
	$(div).window({
		title: "學生管理",
		minimizable: false,
		maximizable: false,
		collapsible: false,
		draggable: false,
		resizable: false,
		inline: false,
		width: 600,
		height: 500,
		modal: true,
		shadow: false,
		onOpen: function(){
			let w1 = $(".panel.window").width();
			let h1 = $(".panel.window").height();
			let w2 = $("body").width();
			let h2 = $("body").height();
			let left = Math.floor((w2 - w1) / 2);
			let top = Math.floor((h2 - h1) / 2);
			$(div).window('move', {top: top * 0.8});
			build();
		},
		onClose: function(){
			$(".btn").unbind("click", click);
			$(div).remove();
		}
	});

	function build(){
		let tbl = "<div style='flex: 1; width: 100%; '>" +
			"  <textarea id='taStudent' style='width: -webkit-calc(100% - 5px); height: -webkit-calc(100% - 5px); border-width: 1px; outline: none; resize: none; font-size: 16px !important;'></textarea>" +
			"</div>" +
			"<div class='footer'>" +
			"  <button id='btnOk' class='btn'>確定</button>" +
			"  <button id='btnCancel' class='btn'>取消</button>" +
			"</div>";
		$(tbl).appendTo("#winEdit");
		
		$(".btn").bind("click", click);
		$("#taStudent").focus();
		$("#taStudent").val(storage.System().students);
	}
	function click(){
		if(this.id == "btnCancel"){
			$("#winEdit").window("close");
		} else {
			let ta = $("#taStudent").val().trim();
			try {
				let arr = JSON.parse(ta);
				if(Array.isArray(arr)){
					for(let i = 0; i < arr.length; i++){
						let row = arr[i], msg = "";
						if(typeof row.id == "undefined" || (row.id + "").length == 0){
							msg = "請在第 " + (i + 1) + "列輸入 id";
						} else if(typeof row.text == "undefined" || (row.text + "").length == 0){
							msg = "請在第 " + (i + 1) + "列輸入 text";
						}
						if(msg.length > 0){
							alert(msg)
							return;
						}
					}
					system.loading.show("上傳中......");
					fireBase.database().ref("teachers/" + fireBase.uid).set(arr)
					.then(()=>{
						system.loading.close();
						storage.System({students: ta});
						$("#winEdit").window("close");
					}).catch(arg=>{
						system.loading.show("無法上傳......");
					});
				} else {
					alert("格式不正確")
				}
			} catch(e){
				alert(e);
			}
		}
	}
}
function adjustUser(){
	if(system.isTeacher() == false){
		$('#divUser').remove();
	} else {
		let user = [{id: 0, text: "教師版"}];
		if(storage.System().students.length > 0)
			user = user.concat(JSON.parse(storage.System().students));
		$(".lblSwitch").remove();
		$('#user').combobox({
			data: user,
			onSelect(value){
				student = value.id == 0 ? "" : value.id;
				readOnly = value.id == 0 ? true : false;
				if(student.length > 0 && !system.isSignon()){
					alert("尚未登入!!");
					return;
				}
				if(student.length > 0){
					fireBase.listen(student + "/" + subject + "/" + lesson);
				} else {
					fireBase.listenClear();
				}
				//if(userData == "undefined")
				userData = {};
				if(fireBase.loaded){
					loadData(function(){
						reload();
					});					
				}
			}
		});
	}
}
function listener(ret){
	if(student.length > 0 && ret.event == "change"){
		//console.log("now: " + (new Date()));
		console.log(ret.key);
		if(ret.key == "html")
			$("#source").tabs("select",0);
		else if(ret.key == "css")
			$("#source").tabs("select",1);
		else
			$("#source").tabs("select",2);
		iframe[ret.key].setValue(ret.data);		
		changeValue(ret, true);
		window.showToast({
			msg: "修改了 " + ret.key.toUpperCase(), 
			icon: "info",
			allowToastClose: false
		});	
	}
}
function adjustPanel(){
	let collapsed = true;
	let west = $('body').layout('panel','west').panel({
		minWidth: 160,
		onCollapse:function(){
			storage.Setting({"west-collapse": "Y"});
		},
		onExpand:function(){
			storage.Setting({"west-collapse": "N"});
		},
		onResize:function(w, h){
		}
	});

	if(typeof setting["west-collapse"] == "string" && setting["west-collapse"] == "Y") {
		$('body').layout('collapse', 'west');
		setTimeout(function(){
			$('body').layout('resize');
		}, 600);		
	}

	let east = $('body').layout('panel','east').panel({
		minWidth: 200,
		onCollapse:function(){
			//alert('collapse');
		},
		onExpand:function(){
			//alert('expand');
		},
		onResize:function(w, h){
			if(collapsed == false){
				setting.east = w;
				storage.Setting(setting);
			}
			eastResizeIcon(w);
		}
	});
	$('#doc').tabs({ // east
		onSelect:function(title, index){
			storage.Setting({doc: index});
		},
		tools:[{
        iconCls:'icon-left',
        handler:function(){
					collapsed = true;
					eastResize(setting.east);
					setTimeout(function(){
						collapsed = false;
					}, 500);
        }
    },{
        iconCls:'icon-right',
        handler:function(){
					collapsed = true;
					eastResize(160);
					setTimeout(function(){
						collapsed = false;
					}, 500);
        }
    }]
	});
	$('#source').tabs({ // center, toolbar
		onSelect:function(title, index){
			panel = title;
			for(let i = 0; i < mode.length; i++){
				let key = mode[i].src;
				if(key.toLowerCase() == panel.toLowerCase()){
					let x = $("div[src='" + key + "'] iframe").get();
					if(x.length == 1){
						x[0].focus();
						iframe[key].myfocus();
					}
					break;
				}
			}
		},
		tools:[{
			iconCls: 'icon-reload',
			id: 'reload',
			handler:function(){
				for(let key in iframe){
					iframe[key].reset();
				}
				if(student.length > 0){
					userData = {};
					loadData(function(){
						reload();
					});
				} else {
					$("#result").attr("src", "./empty.html");
					setTimeout(function(){
						delete userData[lesson];
						storage[subject] = JSON.stringify(userData);
						if(system.isSignon()){
							fireBase.setUserData(fireBase.uid + "/" + subject + "/" + lesson, null, function(){
							});						
						}
					}, 1000);				
				}
			}
		}, {
			iconCls:'icon-speech',
			id: "speech",
			handler:function(){
				if(!system.isTeacher() || student.length > 0){
					$('#winSpeech').window('open');
				} else {
					alert("請先選取學生才可進行對話!!")
				}
			}		
		}, {
			iconCls:'icon-student',
			id: "student",
			handler:function(){
				studentAdd();
			}
		}, {
			iconCls:'icon-man',
			id: "signon",
			handler:function(){
				if(system.isSignon()){
					var r = confirm("是否確定登出!");
					if (r == true) {
						storage.clear();
						location.reload();
					} 
				} else
					fireBase.login();
			}
    }]
	});

	function eastResizeIcon(w){
		if($("#doc .tabs-tool table td").size() == 0){
			setTimeout(function(){
				eastResizeIcon(w);
			}, 500);
		} else {
			let max = w > 160 ? true : false;
			$("#doc .tabs-tool table td:nth-child(1)").css("display", max == false ? "table-cell" : "none");
			$("#doc .tabs-tool table td:nth-child(2)").css("display", max == true ? "table-cell" : "none");
		}
	}
	function eastResize(w){
		var p = $('body').layout('panel','east');  
		p.panel('resize',{width: w});
		$('body').layout('resize');
		eastResizeIcon(w);
	}

	let w = typeof setting.east == "number" ? setting.east : 300;
	eastResize(w);
	setTimeout(function(){
		collapsed = false;
		if(setting.doc != 0)
			$("#doc").tabs("select", setting.doc);
	}, 500);
}
let speechOpened = false;
function centerIcon(){ // 
	if($("#center .tabs-tool table td").size() == 0){
		setTimeout(function(){
		}, 500);
	} else {
		$("#center .tabs-tool table td:nth-child(1)").css("display", // reload
			(system.isTeacher() && student.length == 0) || (!system.isTeacher() && readOnly) ? "none" : "table-cell");
		$("#center .tabs-tool table td:nth-child(2)").css("display", // msg
			! system.isSignon() ? "none" : "table-cell");
			$("#center .tabs-tool table td:nth-child(3)").css("display", // msg
			! system.isTeacher() ? "none" : "table-cell");
		$('body').layout('resize');
		// $("#center .tabs-tool table td:nth-child(2)").css("display", 
		// 	system.isSignon() ? "none" : "table-cell");
		//$("#center .tabs-tool").remove();		
		if(system.isTeacher())
			$(".icon-student").css("background", "url(icons/student.png) no-repeat center center");
		if(system.isSignon())
			$(".icon-man").css("background", "url(icons/user.png) no-repeat center center");
	}
}

function changeMenu(index){
	setting.current = index;
	subject = menu[index].text;
	$('#tree').tree({
		data: menu[index].data
	});
	$("#divSubject").text(subject);
	if((system.isSignon() == true || ! system.isTeacher()) || student.length > 0){ // 自 firebase 撈資料, 或 localstorage
		loadData(function(){
			findTree(setting[subject]);
		});
	} else
		findTree(setting[subject]);
}

function loadData(callback){
	userData = {};
	if(!system.isTeacher()){ // 先自 localstorage
		let x = storage[subject];
		if(typeof x == "string" && x.length > 0)
			userData = JSON.parse(x);
	}

	if(system.isSignon() == true){ // 如有登錄, 再自 firebase 撈資料
		system.loading.show("系統登入中......");
		fireBase.signIn(storage.System().user, storage.System().pwd, function(ret){
			if(ret == "ok"){
				let user = student.length > 0 ? student : fireBase.uid;
				//console.log(user)
				fireBase.getUserData(user + "/" + subject, function(ret){
					if(typeof ret == "object" && ret != null){
						userData = Object.assign(userData, ret);
					}
					callback();
					system.loading.close();
				});
			} else 
				system.loading.show("系統無法登入!!");
		});
	} else {
		callback();
	}
}

function findTree(node){
	if(menu[setting.current].data.length > 0){
		if(typeof node == "string") {
			if(node.indexOf("-") == -1){
				node = "00-basic";
			}
			node = $('#tree').tree('find', node);
		}
		if(node != null){
			$('#tree').tree('select', node.target);
			treeClick(node);
		}
	}
}

function treeClick(node){
	setting[subject] = node.id;
	storage.Setting(setting);
	if(typeof node.context == "string" && node.context.length > 0){
		$("#context").attr("src", "./handout/" + subject + "/" + node["context"]);
	} else 
		$("#context").attr("src", "");
	$("#source").tabs("select",0);
	//$("#doc").tabs("select",0);
	if(student.length > 0){
		fireBase.listen(student + "/" + subject + "/" + node.id);
	}
	loadPage(node, true);
}

function loadPage(node, changed){
	lesson = node.id;
	if(typeof changed == "boolean" && changed == true && !system.isTeacher()){
		if(typeof userData == "object" && typeof userData[lesson] == "object"){
			readOnly = false;
		} else 
			readOnly = true;
		$("#switch").prop("checked", readOnly);
	}
	$("#divSubject").text(subject+ ": " + node.text);

	if(readOnly == true && typeof node.html == "string" && node.html.length > 0){
		$("#result").attr("src", "./handout/" + subject + "/" + node["html"]);
		result.location.assign("./handout/" + subject + "/" + node["html"]);
	} else {
		result.location.assign("./empty.html");
	}
	centerIcon();
	function loadEditor(index){
		if(index >= mode.length){
			//setTimeout(function(){
			//}, 600)
		} else if (typeof iframe[mode[index].src] == "object") {
			let key = mode[index].src, key2 = mode[index].node;
			if((readOnly == false || student.length > 0) && typeof userData == "object"){
				let s = typeof userData[lesson] == "object" && typeof userData[lesson][key] == "string"
					? userData[lesson][key] : "";
				if(s.length == 0 && key2 == "html"){
					if(student.length > 0){
						iframe[key].setValue(subject, node[key2]);
						readOnly = true;
						if(index == 0){
							result.location.assign("./handout/" + subject + "/" + node["html"]);
						}
					} else {
						iframe[key].reset();
						result.location.assign("./empty.html");
					}
				} else {
					iframe[key].setValue(s);
					changeValue({key: key, data: s}, false);
				}
				//console.log(key + ": " + s)
				iframe[key].readOnly(readOnly);
				setTimeout(function(){
					loadEditor(index + 1);
				}, 600)
				
			} else {
				if(typeof node[key2] == "undefined")
					iframe[key].setValue("");
				else
					iframe[key].setValue(subject, node[key2]);
				iframe[key].readOnly(readOnly);
				$("#switch").prop("checked", readOnly);
				loadEditor(index + 1);
			}
		} else {
			setTimeout(function(){
				loadEditor(index)
			}, 500);
		}
	}
	loadEditor(0);
}

function changeValue(e, changed){ // 來自 iframe 修改資料
	if(e.key == "css"){
		changeCSS(e.data);
	} else if(e.key == "javascript"){
		changeJS(e.data);
	} else {
		try{
			let html = e.data;
			if(typeof changed == "undefined" || changed == true){
				if(readOnly == false && typeof userData[lesson].css == "string" && userData[lesson].css.length > 0){
					let newCSS = '<style type="text/css" id="newCSS">' + userData[lesson].css + '</style>';
					html = html.replace("</head>", newCSS + "</head>");
				}
				if(readOnly == false && typeof userData[lesson].javascript == "string" && userData[lesson].javascript.length > 0){
					let newJS = '<script id="newJS">' + userData[lesson].javascript + '<\/script>';
						html = html.replace("</head>", newJS + "</head>");
				}
			}
			$("#result").prop("srcdoc", html);
		} catch (e) {

		}
	}
	if(!system.isTeacher() && (typeof changed == "undefined" || changed == true)){
		if(typeof userData == "undefined")
			userData = {};
		if(typeof userData[lesson] == "undefined")
				userData[lesson] = {};
			userData[lesson][e.key] = e.data;
			storage[subject] = JSON.stringify(userData);

			if(system.isSignon() == true && ! system.isTeacher()){
				fireBase.setUserData(fireBase.uid + "/" + subject + "/" + lesson + "/" + e.key, e.data, function(){

				});
			}
	}
}

function changeJS(js) {
	let ext = result.document.querySelector("script[src]");
	if(ext != null){
		ext.setAttribute("src", "");
		ext.parentNode.removeChild(ext);
	}

	let newJS = result.document.querySelector("#newJS");
	if(newJS != null){
		newJS.parentNode.removeChild(newJS);
	}
	newJS = result.document.createElement("script");
	newJS.id = "newJS"
	if(result.document.getElementsByTagName("head").length > 0){
		result.document.getElementsByTagName("head")[0].appendChild(newJS);
		newJS.innerHTML = js;		
	}
}

function changeCSS(css) { // ok
	let ext = result.document.querySelector("link");
	if(ext != null){
		ext.setAttribute("href", "");
		ext.parentNode.removeChild(ext);
	}

	let newCSS = result.document.querySelector("#newCSS");
	if(newCSS != null){
		newCSS.parentNode.removeChild(newCSS);
	}
	newCSS = result.document.createElement("style");
	newCSS.id = "newCSS"
	if(result.document.getElementsByTagName("head").length > 0){
		result.document.getElementsByTagName("head")[0].appendChild(newCSS);
		newCSS.innerHTML = css;
	}
}
/*
cd /Users/jimc/nodeJS/ && node index
*/
</script>
</html>