<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>讀取 Excel 儲存格</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" type="text/css" href="../tutor/jQuery/easyui/themes/default/easyui.css">
  <script type="text/javascript" src="../tutor/jQuery/jquery.min.js"></script>
  <script type="text/javascript" src="../tutor/jQuery/easyui/jquery.easyui.min.js"></script>
  <style>
    table,
    th,
    td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 5px;
      text-align: left;
    }
    tr {
      min-height: 20px;
    }
    .has-tooltip {
      position: relative;
    }
    .has-tooltip::after {
      content: '';
      position: absolute;
      top: 2px;
      right: 2px;
      width: 6px;
      height: 6px;
      background-color: red;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <h2>選擇 Excel 檔案</h2>
  <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" />
  <table id="excelTable" style="margin-top: 10px;""></table>

  <script>
    document.getElementById('excelFile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) {
        return;
      }
      const reader = new FileReader();

      reader.onload = function (event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        // 取得第一個工作表
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        // 將工作表轉成二維陣列
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        const table = document.getElementById('excelTable');
        table.innerHTML = ''; // 清空舊資料

        let maxCols = 0;
        for(let i = 0; i < 10; i++) {
          let row = rows[i];
          // console.log(i + ": " + row.length)
          if(maxCols < row.length) {
            maxCols = row.length;
          }
        }
        if(maxCols == rows[4].length) maxCols = 0;

        let s = "";
        rows.forEach((row, index) => {
          if(index > 3 && row.length > 10) {
            const tr = table.insertRow();
            const td1 = tr.insertCell();
            td1.textContent = index + 1;
            td1.style.backgroundColor = 'lightgray';
            if(maxCols > 0 && row.length == maxCols && row[maxCols - 1]) {
              td1.classList.add('has-tooltip');
              const tooltipContent = String(row[maxCols - 1]);
              $(td1).tooltip({
                content: `<div style="padding:5px; max-width:300px; font-size:16px; white-space: pre-wrap; word-wrap: break-word;">${tooltipContent}</div>`,
                trackMouse: true,
                position: 'right',
                onShow: function(){
                    $(this).tooltip('tip').css({
                        backgroundColor: '#FFFFE1',
                        borderColor: '#CCCCCC'
                    });
                }
              });
            }
            row.forEach((cell, cellIndex) => {
              if(maxCols > 0 && cellIndex == maxCols - 1) {
                s += (s.length > 0 ? "\n" : "") + index + ": " + cell
              } else if(cellIndex > 1) {
                const td = tr.insertCell();
                td.textContent = cell;
              }
            });            
          }
        });
        // console.log(s)
      };
      reader.readAsArrayBuffer(file);
    });


    /*
6: 1戶只有能有1個人回答，如果全戶都没人回答47要備註
7: 1.關係如為巳婚者配偶要出現在戶內,如果没有的話要備源因

9: 1.47年次後出生教育程度要為國中以上
   2.夫妻年齡差距10Y要跳出檢誤
   3.子女與父母年齡差距16Y以下跳出檢誤

10: 戶內有配偶的要成雙成對
11: 1.在學者要為23Y以下
    2.肄業者跳出提示
    3.從未正規學校求學過要為70Y以上
12: 如是1跳出提示
13: 1.夫妻的教育程度差四皆以上要跳出提示
    2.教育程度要和年齡搭配
16: 本列為1請提示
17: 1.戶內人口僅1人且65Y以上又無工作，這一選項只能為8
    2.同1戶內有2個選7跳出檢誤
    3.65Y以下，選8,47要備註
    4.選11要備註是三者何種
37: 8列選1者這裡要有數字編號
38: 38列有數字者這列要有文字
39: 38.39值這列要有編號
40: 40有編號這列要有文字
41: 38~41列有值這裡要有值
42: 38~42有值這列要有值
43: 43列有值44要有值
44: 1.42列選1本列要為2
    2.45列選4者42列選項要為2以
45: 本列的3個字要和39列一樣
    */
  </script>
</body>
</html>
