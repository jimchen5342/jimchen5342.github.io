"use strict";var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var SocketClient=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"all";_classCallCheck(this,t),this.socketURL=n,this.socketPath=null===o?"/socket.io":o,this.ns="/",this.socket=null,this.defaultChannel=c,this.orderId=null,this.autoReconnect=!0,this.reconnectDelay=5e3,this.reconnectAttemps=20,this.nowReconnectAttemp=0,this.isConnected=!1,this.cdn={io:"https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.slim.js"},this.connectHandler=null,this.disconnectHandler=null,void 0===this.constructor.name?this.className="":this.className=this.constructor.name,null===e?null!==this.getLocal("clientId")?this.setClientId(this.getLocal("clientId")):this.setClientId():this.setClientId(e)}return _createClass(t,null,[{key:"author",get:function(){return"ozzysun"}},{key:"ver",get:function(){return"0.1.0"}},{key:"ioVer",get:function(){return"2.0.3"}},{key:"useTrace",get:function(){return!1}}]),_createClass(t,[{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null!==t&&(this.reconnectDelay=t),null!==n&&(this.reconnectAttemps=n),this.libReady(function(){e.ready(function(){null!==o&&o()})})}},{key:"setClientId",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null===t&&(t="client_"+(new Date).getTime()),this.clientId=t,this.setLocal("clientId",this.clientId)}},{key:"getClientId",value:function(){return this.clientId}},{key:"setOrderId",value:function(t){this.orderId=t}},{key:"getOrderId",value:function(){return this.orderId}},{key:"setNickNameId",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null===t&&(t="usr"+(new Date).getTime()),this.setLocal("nickNameId",t)}},{key:"getNickNameId",value:function(){return this.getLocal("nickNameId")}},{key:"listen",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=setInterval(function(){null!==t.socket&&(clearInterval(n),t.socketHandler(e),t.ioHandler())},200)}},{key:"socketHandler",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.socket.on(this.defaultChannel,function(n){var o=n.from,c=n.to;t.trace("Have Message obj!!"),t.trace(n),c=-1!==c.indexOf(",")?c.split(", "):[c];var i=[t.clientId,"all"];null!==t.orderId&&i.push(t.orderId);for(var l=0;l<c.length;l++)-1===i.indexOf(c[l])||"all"===c[l]&&o===t.clientId||null!==e&&e(n)}),this.socket.on("disconnect",function(){t.trace("---------------Disconnect--"),t.emit("NetStatus","Socket.DisConnect"),null!==t.disconnectHandler&&t.disconnectHandler()}),this.socket.on("connecting",function(){t.trace("---------------Connecting---"),t.emit("NetStatus","Socket.Connecting")}),this.socket.on("connect",function(){t.trace("---------------Connect !!---"),t.nowReconnectAttemp=0,t.isConnected=!0,t.emit("NetStatus","Socket.Connect",t.socket.id),null!==t.connectHandler&&t.connectHandler()}),this.socket.on("connect_error",function(){t.disconnect(),t.isConnected=!1,t.trace("---------------Connection Failed---"),t.emit("NetStatus","Socket.ConnectError"),t.autoReconnect&&setTimeout(function(){t.nowReconnectAttemp<t.reconnectAttemps?(t.trace("do reconnect!!.......nowReconnectAttemp="+t.nowReconnectAttemp),t.socket.open(),t.nowReconnectAttemp++):(t.trace("重新連線超過次數, 停止"),t.nowReconnectAttemp=0,t.emit("NetStatus","Socket.ConnectFail"))},t.reconnectDelay)}),this.socket.on("connect_timeout",function(){t.trace("---------------Connection Timeout---"),t.emit("NetStatus","Socket.TIME_OUT")}),this.socket.on("reconnect",function(e){t.trace("Socket reconnect="+e+"ms")}),this.socket.on("reconnecting",function(e){t.trace("Socket reconnecting="+e+"ms")}),this.socket.on("reconnect_error",function(e){t.trace("Socket reconnect error"),t.trace(e)}),this.socket.on("error",function(e){t.emit("NetStatus","Socket.Error",e),t.trace(e)}),this.socket.on("ping",function(){t.emit("NetStatus","Socket.Ping",t.socket.id)}),this.socket.on("pong",function(e){t.emit("NetStatus","Socket.Pong",e)})}},{key:"ioHandler",value:function(){}},{key:"send",value:function(t,e){var n={from:this.clientId,to:t,time:(new Date).getTime(),data:e};null!==this.socket?this.socket.emit(this.defaultChannel,n):this.trace("Warning!!socket not exist")}},{key:"connect",value:function(){var t=this,e=(arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]?arguments[1]:"all");console.log("this.socketURL="+this.socketURL+" this.socketPath="+this.socketPath+" room="+e);var n={secure:-1!==this.socketURL.indexOf("https"),transports:["polling","websocket"],autoConnect:!0,reconnection:!0};null!==this.socketPath&&(n.path=this.socketPath),console.log("connect="+this.socketURL+" room="+e),this.socket="all"===e?window.io(""+this.socketURL+this.ns+"?author=ozzysun",n):window.io(""+this.socketURL+this.ns+"?author=ozzysun&room="+e,n),this.socket.on("connect",function(){}),setTimeout(function(){t.trace(".......socket id="+t.socket.id)},500)}},{key:"disconnect",value:function(){null!==this.socket&&this.socket.disconnect()}},{key:"reconnect",value:function(){this.socket.open()}},{key:"onConnect",value:function(t){this.connectHandler=t}},{key:"onDisconnect",value:function(t){this.disconnectHandler=t}},{key:"ready",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=setInterval(function(){t.connect(t.ns,t.defaultChannel),null!==e&&e(),clearInterval(n),t.trace("New SocketClient ready")},1e3)}},{key:"libReady",value:function(t){void 0!==window.io?(this.trace("io already exist"),t()):(this.trace("start load io lib......."),this.loadScript(this.cdn.io,t))}},{key:"loadScript",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=document.createElement("script");c.type="text/javascript",c.setAttribute("defer","defer"),null!==o&&(c.id="jss_"+o),c.readyState?c.onreadystatechange=function(){"loaded"!==c.readyState&&"complete"!==c.readyState||(c.onreadystatechange=null,e.trace("load url="+t+" success"),null!==n&&n())}:c.onload=function(){null!==n&&n()},c.src=t,document.getElementsByTagName("head")[0].appendChild(c)}},{key:"setLocal",value:function(t,e){localStorage.setItem(t,e)}},{key:"getLocal",value:function(t){return localStorage.getItem(t)}},{key:"trace",value:function(t){console.log(t)}},{key:"emit",value:function(){}}]),t}();window.SocketClient=SocketClient;